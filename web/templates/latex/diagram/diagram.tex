% -*- LaTeX -*-
% -*- coding: utf-8 -*-
%
% Alec Aivazis <alec@aivazis.com>
% 
% (c) 2009-2015 all rights reserved
%

% A package for drawing feynman diagrams in LaTex

\documentclass[border=1pt]{standalone}
\usepackage{tikz}
\usepackage{xifthen}
\usepackage{kvoptions}
\usepackage{fp}
\usepackage{lengthconvert}

% turn off the fp messages
\FPmessagesfalse

% treat @ like a normal letter
\makeatletter


%------------------------------------------------------------------------------
% configuration parameters                                           
%------------------------------------------------------------------------------

% define the diagram configuration settings family
\SetupKeyvalOptions{family=diagram, prefix=diagram@}
\DeclareStringOption[1cm]{unit}
\DeclareStringOption[An Example Feynman Diagram]{title}

% define the propagator configuration settings family
\SetupKeyvalOptions{family=style, prefix=style@}
\DeclareStringOption[black]{color}[black]
\DeclareStringOption[1]{lineWidth}
\DeclareBoolOption[false]{endcaps}
\DeclareStringOption[5]{gluonWidth}


%------------------------------------------------------------------------------
% the feynman diagram environment                                           
%------------------------------------------------------------------------------

% define an enviroment to encompass a single diagram
\newenvironment{feynman}[1][]
% before the content
{
    % load the diagram configuration settings
    \setkeys{diagram}{#1}
    % start the tikz environment
    \begin{tikzpicture}[x=\diagram@unit, y=\diagram@unit]
}
% after the content
{
    % close the tikz environment
    \end{tikzpicture}
}


%------------------------------------------------------------------------------
% utility macros
%------------------------------------------------------------------------------

% compute the length between two points 
\def\calcLength(#1,#2)#3{
    % compute the delta between two points 
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas as numbers
    \FPeval\@temp@a{\pgfmath@tonumber{\pgf@xa}}
    \FPeval\@temp@b{\pgfmath@tonumber{\pgf@ya}}
    % store the sum of the squares
    \FPeval\@temp@sum{(\@temp@a*\@temp@a+\@temp@b*\@temp@b)}
    % take the square root of the result
    \FProot{\FPMathLen}{\@temp@sum}{2}
    % cut off at 5 decimal places
    \FPround\FPMathLen\FPMathLen5\relax
    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\FPMathLen}
}

% compute the angle between two points 
\def\calcAngle(#1,#2)#3{
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    % extract the delta between the two points
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas as numbers
    \FPeval{\deltaX}{\pgfmath@tonumber{\pgf@xa}}
    \FPeval{\deltaY}{\pgfmath@tonumber{\pgf@ya}}
    \FPeval{\angle}{round(arctan(\deltaY / \deltaX) * 180 / pi, 5)}
    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\angle}
}

% leave behind the style parameters that align the line by \angle and \scale


%------------------------------------------------------------------------------
% propagator styles
%------------------------------------------------------------------------------

% fermions
\newcommand*{\fermion}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % draw the line
    \draw[color=\style@color, line width = \style@lineWidth] ({#2}) -- ({#3});
}


% dashed propagators
\newcommand*{\dashed}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % draw the dasked line
    \draw[\style@color, line width = \style@lineWidth, dashed] ({#2}) -- ({#3});
}


% gluons
\newcommand*{\gluon}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}

    % create TikZ coordinates at the end points
    \coordinate  (start) at (#2);
    \coordinate  (finish) at (#3);
    % store the distance between the two points
    \calcLength(start,finish){length} % stores it in a macro called \length
    % store the angle between the two points
    \calcAngle(start,finish){angle} % stores it in a macro called \length

    \FPeval{\gluonWidth}{\style@gluonWidth}
    % store a value for half of the gluonWidth
    \FPeval{\halfWidth}{\gluonWidth/2}
    % store the closest whole number of full periods
    \FPeval{\nLoops}{round((\length / \gluonWidth ) - 1, 0)}

    % if we dont fit a whole loop between the two points
    \ifthenelse{\equal{\nLoops}{0}}{
        % use a fermion line instead
        \fermion{#2}{#3}

    % we fit at least one loop between the two points
    }{

        % if they want the end caps (to draw the right kind of line)
        \ifstyle@endcaps
         
            \FPeval{\ymax}{\halfWidth}
            \FPeval{\ymin}{0-\halfWidth}

            % draw the opening end cap
            \draw[\style@color, rotate=\angle, line width = \style@lineWidth] 
                (0,0) .. controls (\halfWidth, 0) and (0, \ymin) .. (\halfWidth, \ymin);

            % for each loop that we have to draw
            \foreach \loopNumber in {1,...,\nLoops}{
                % compute the starting location of the loop
                \FPeval{\x}{\loopNumber * \gluonWidth - \halfWidth}
                % compute the half way point of the loop
                \FPeval{\xMid}{\halfWidth + \x}
                % compute the endpoint of the loop
                \FPeval{\xFinal}{\gluonWidth + \x}
                
                % draw the first half of the loop
                \draw[\style@color, rotate=\angle, line width = \style@lineWidth] 
                    (\x, \ymin) .. controls (\xFinal, \ymin) and (\xFinal, \ymax) .. (\xMid, \ymax);
                % draw the second half of the loop
                \draw[\style@color, rotate=\angle, line width = \style@lineWidth] 
                    (\xMid, \ymax) .. controls (\x, \ymax) and (\x, \ymin) .. (\xFinal, \ymin);
            }

            % compute the locations for the closing end cap
            \FPeval{\finalStart}{(\nLoops + 1) * \gluonWidth - \halfWidth}
            \FPeval{\finalHalf}{\finalStart + \halfWidth}
            \FPeval{\finalStop}{\finalStart + \halfWidth}
            % draw the closing end cap
            \draw[\style@color, rotate=\angle, line width = \style@lineWidth] 
                (\finalStart, \ymin) .. controls (\finalStop, \ymin) and (\finalStart, 0) .. (\finalStop, 0);

        % they did not want end caps
        \else
            % store a value for the height of the gluon loop
            \FPeval{\height}{\gluonWidth}
            % for each loop that we have to draw
            \foreach \loopNumber in {0,...,\nLoops}{
                % compute the starting location of the loop
                \FPeval{\x}{\loopNumber * \gluonWidth}
                % compute the midpoint of the loop
                \FPeval{\xMid}{\halfWidth + \x}
                % compute the endpoint of the loop
                \FPeval{\xFinal}{\gluonWidth + \x}

                % draw the first half of the loop
                \draw[\style@color, rotate=\angle, line width = \style@lineWidth] 
                    (\x,0) .. controls (\xFinal, 0) and  (\xFinal, \height) .. (\xMid, \height);
                % draw the second half of the loop
                \draw[\style@color, rotate=\angle, line width = \style@lineWidth] 
                    (\xMid,\height) .. controls (\x, \height) and  (\x, 0) .. (\xFinal, 0);
            }
        \fi
    }
}


% electroweak line
%\draw (0,0) to[out=0, in=180] (\halfWidth, \height);


% turn @ back into a special character
\makeatother


% draw an example diagram
\begin{document}
    \begin{feynman}[title=Example Feynman Diagram, unit=1cm] 
        \fermion{1,0}{1,1}
        \fermion{0,1}{0,0}
        \gluon[endcaps=true]{0,1}{1,0}
    \end{feynman}
\end{document}


% end of file