% -*- LaTeX -*-
% -*- coding: utf-8 -*-
%
% Alec Aivazis <alec@aivazis.com>
% 
% (c) 2009-2015 all rights reserved
%

% A package for drawing feynman diagrams in LaTex

\documentclass[varwidth=true, border=1pt]{standalone}
\usepackage{tikz}
\usepackage{ifthen}
\usepackage{kvoptions}
\usepackage{fp}

% treat @ like a normal letter
\makeatletter


% define the propagator configuration settings family
\SetupKeyvalOptions{
    family=style,
    prefix=style@
}

% define the propagator configuration parameters
\DeclareStringOption[black]{color}[black]
\DeclareStringOption[1]{lineWidth}
\DeclareBoolOption[false]{endcaps}
\DeclareStringOption[10]{gluonWidth}

% define an enviroment to encompass a single diagram
\newenvironment{feynman}[1][]
% before the content
{
    \begin{tikzpicture}[]
}
% after the content
{
    \end{tikzpicture}
}



% compute the length between two points 
\def\calcLength(#1,#2)#3{
    % compute the delta between two points 
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas as numbers
    \FPeval\@temp@a{\pgfmath@tonumber{\pgf@xa}}
    \FPeval\@temp@b{\pgfmath@tonumber{\pgf@ya}}
    % store the sum of the squares
    \FPeval\@temp@sum{(\@temp@a*\@temp@a+\@temp@b*\@temp@b)}
    % take the square root of the result
    \FProot{\FPMathLen}{\@temp@sum}{2}
    % cut off at 5 decimal places
    \FPround\FPMathLen\FPMathLen5\relax
    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\FPMathLen}
}


% define macros to wrap around various propagator styles

% fermions
\newcommand*{\fermion}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % draw the line
    \draw[color=\style@color, line width = \style@lineWidth] ({#2}) -- ({#3});
}

% dashed propagators
\newcommand*{\dashed}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % draw the dasked line
    \draw[\style@color, line width = \style@lineWidth, dashed] ({#2}) -- ({#3});
}

% gluons
\newcommand*{\gluon}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}

    % store a value for half of the gluonWidth
    \FPeval{\halfWidth}{\style@gluonWidth/2}
    % store a value for the height of the gluon loop
    \FPeval{\height}{\style@gluonWidth}

    % create TikZ coordinates at the end points
    \coordinate  (start) at (#2);
    \coordinate  (finish) at (#3);
    % store the distance between the two points
    \calcLength(start,finish){length} % stores it in a macro called \length

    % store the closest whole number of full periods
    \FPeval{\nLoops}{round(\length / \style@gluonWidth / 2, 0)}

    % if they want the end caps
    \ifstyle@endcaps
        % we are going to use one loop to draw the endcaps so remove one from nLoops
        \FPeval{\nLoops}{round(\nLoops - 1, 0)}

        \fermion{#2}{#3}
    % they did not want end caps
    \else
        \dashed{#2}{#3}
    \fi

    \node{\nLoops};

}



% turn @ back into a special character
\makeatother


% draw an example diagram
\begin{document}
    \begin{feynman}
        \fermion[color=yellow]{1,0}{0,0}
        \gluon[endcaps=true]{0,1}{0,0}
    \end{feynman}
\end{document}


% end of file