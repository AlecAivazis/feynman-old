% -*- LaTeX -*-
% -*- coding: utf-8 -*-
%
% Alec Aivazis <alec@aivazis.com>
% 
% (c) 2009-2015 all rights reserved
%

% A package for drawing feynman diagrams in LaTex

\documentclass[border=1pt]{standalone}
\usepackage{tikz}
\usepackage{xifthen}
\usepackage{kvoptions}
\usepackage{fp}

% turn off the fp messages
\FPmessagesfalse

% treat @ like a normal letter
\makeatletter


%------------------------------------------------------------------------------
% configuration parameters                                           
%------------------------------------------------------------------------------

% define the diagram configuration settings family
\SetupKeyvalOptions{family=diagram, prefix=diagram@}
\DeclareStringOption[in]{unit}
\DeclareStringOption[An Example Feynman Diagram]{title}

% define the propagator configuration settings family
\SetupKeyvalOptions{family=style, prefix=style@}
\DeclareStringOption[black]{color}[black]
\DeclareStringOption[1]{lineWidth}
\DeclareBoolOption[false]{endcaps}
\DeclareStringOption[1/3]{gluonWidth}


%------------------------------------------------------------------------------
% the feynman diagram environment                                           
%------------------------------------------------------------------------------

% define an enviroment to encompass a single diagram
\newenvironment{feynman}[1][]
% before the content
{
    % load the diagram configuration settings
    \setkeys{diagram}{#1}
    % start the tikz environment
    \begin{tikzpicture}[x=1\diagram@unit, y=1\diagram@unit]
}
% after the content
{
    % close the tikz environment
    \end{tikzpicture}
}


%------------------------------------------------------------------------------
% utility macros
%------------------------------------------------------------------------------

% convert a particular length to the designated unit
% i.e. \convertto{mm}{1pt}
\newcommand*{\convertto}[2]{\strip@pt\dimexpr #2*65536/\number\dimexpr 1#1}

% compute the length between two points 
\def\calcLength(#1,#2)#3{
    % compute the delta between two points 
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas as numbers
    \FPeval\@temp@a{\pgfmath@tonumber{\pgf@xa}/72.27}
    \FPeval\@temp@b{\pgfmath@tonumber{\pgf@ya}/72.27}

    % store the sum of the squares
    \FPeval\@temp@sum{(\@temp@a*\@temp@a+\@temp@b*\@temp@b)}
    % take the square root of the result
    \FProot{\FPMathLen}{\@temp@sum}{2}
    % cut off at 5 decimal places
    \FPround\FPMathLen\FPMathLen9\relax
    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\FPMathLen}
}

% compute the angle between two points 
\def\calcAngle(#1,#2)#3{
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    % extract the delta between the two points
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas as numbers
    \FPeval{\deltaX}{\pgfmath@tonumber{\pgf@xa}}
    \FPeval{\deltaY}{\pgfmath@tonumber{\pgf@ya}}
    % use pgf to compute atan2 
    \pgfmathparse{atan2(\deltaY, \deltaX)}
    %  set the angle to the result
    \FPeval{\angle}{round(\pgfmathresult , 5)}

    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\angle}
}

% shortcut macro to print an expression to the console
\newcommand*{\print}[1]{\typeout{#1}}


%------------------------------------------------------------------------------
% propagator styles
%------------------------------------------------------------------------------

% fermions
\newcommand*{\fermion}[3][]{

    % load the configuration parameters
    \setkeys{style}{#1}
    % draw the line
    \draw[color=\style@color, line width = \style@lineWidth] (#2) -- (#3);
}


% dashed propagators
\newcommand*{\dashed}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % draw the dasked line
    \draw[\style@color, line width = \style@lineWidth, dashed] ({#2}) -- ({#3});
}


% gluons
\newcommand*{\gluon}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}

    % create TikZ coordinates at the end points
    \coordinate  (start) at (#2);
    \coordinate  (finish) at (#3);
    % store the distance between the two points
    \calcLength(start,finish){length} % stores it in a macro called \length
    % store the angle between the two points
    \calcAngle(start,finish){angle} % stores it in a macro called \angle

    % turn the start coordinate into a pgf point
    \pgfpointanchor{start}{center}
    \FPeval{\startX}{\pgfmath@tonumber{\pgf@x}}
    \FPeval{\startY}{\pgfmath@tonumber{\pgf@y}}

    \FPeval{\gluonWidth}{\style@gluonWidth}
    % store a value for half of the gluonWidth
    \FPeval{\halfWidth}{\gluonWidth/2}
    % store the closest whole number of full periods
    \FPeval{\nLoops}{round((\length / \gluonWidth ) - 1, 0)}
    \FPeval{\totalLength}{(\nLoops+1) * \gluonWidth}
    \FPeval{\scale}{\length / \totalLength}

    % if we dont fit a whole loop between the two points
    \ifthenelse{\equal{\nLoops}{0}}{
        % use a fermion line instead
        \fermion{#2}{#3}

    % we fit at least one loop between the two points
    }{

        % if they want the end caps (to draw the right kind of line)
        \ifstyle@endcaps
         
            \FPeval{\ymax}{\halfWidth}
            \FPeval{\ymin}{0-\halfWidth}

            % draw the opening end cap
            \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                (0,0) .. controls (\halfWidth, 0) and (0, \ymin) .. (\halfWidth, \ymin);
            % for each loop that we have to draw
            \foreach \loopNumber in {1,...,\nLoops}{
                % compute the starting location of the loop
                \FPeval{\x}{\loopNumber * \gluonWidth - \halfWidth}
                % compute the half way point of the loop
                \FPeval{\xMid}{\halfWidth + \x}
                % compute the endpoint of the loop
                \FPeval{\xFinal}{\gluonWidth + \x}
                
                % draw the first half of the loop
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                    (\x, \ymin) .. controls (\xFinal, \ymin) and (\xFinal, \ymax) .. (\xMid, \ymax);
                % draw the second half of the loop
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                    (\xMid, \ymax) .. controls (\x, \ymax) and (\x, \ymin) .. (\xFinal, \ymin);
            }

            % compute the locations for the closing end cap
            \FPeval{\finalStart}{(\nLoops+1) * \gluonWidth - \halfWidth}
            \FPeval{\finalHalf}{\finalStart + \halfWidth}
            \FPeval{\finalStop}{\finalStart + \halfWidth}
            % draw the closing end cap
            \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                (\finalStart, \ymin) .. controls (\finalStop, \ymin) and (\finalStart, 0) .. (\finalStop, 0);

        % they did not want end caps
        \else
            % store a value for the height of the gluon loop
            \FPeval{\height}{\gluonWidth}
            % for each loop that we have to draw
            \foreach \loopNumber in {0,...,\nLoops}{
                % compute the starting location of the loop
                \FPeval{\x}{\loopNumber * \gluonWidth}
                % compute the midpoint of the loop
                \FPeval{\xMid}{\halfWidth + \x}
                % compute the endpoint of the loop
                \FPeval{\xFinal}{\gluonWidth + \x}
                % draw the first half of the loop
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                    (\x,0) .. controls (\xFinal, 0) and  (\xFinal, \height) .. (\xMid, \height);
                % draw the second half of the loop
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                    (\xMid,\height) .. controls (\x, \height) and  (\x, 0) .. (\xFinal, 0);
            }
        \fi
    }
}


% electroweak lines
\newcommand*{\electroweak}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}

    % create TikZ coordinates at the end points
    \coordinate  (start) at (#2);
    \coordinate  (finish) at (#3);
    % store the distance between the two points
    \calcLength(start,finish){length} % stores it in a macro called \length
    % store the angle between the two points
    \calcAngle(start,finish){angle} % stores it in a macro called \angle

    % turn the start coordinate into a pgf point
    \pgfpointanchor{start}{center}
    \FPeval{\startX}{\pgfmath@tonumber{\pgf@x}}
    \FPeval{\startY}{\pgfmath@tonumber{\pgf@y}}

    \FPeval{\period}{\style@gluonWidth}
    % store a value for half of the gluonWidth
    \FPeval{\halfPeriod}{\period/2}
    % store the closest whole number of full periods
    \FPeval{\nLoops}{round((\length / \period ) - 1, 0)}
    \FPeval{\totalLength}{(\nLoops+1) * \period}
    \FPeval{\scale}{\length / \totalLength}

    % if we dont fit a whole loop between the two points
    \ifthenelse{\equal{\nLoops}{0}}{
        % use a fermion line instead
        \fermion{#2}{#3}

    % we fit at least one loop between the two points
    }{
        % store the amplitude of the curve
        \FPeval{\amplitude}{\period * 3 / 2}
        % save the maximum height of the curve
        \FPeval{\ymax}{\amplitude}
        % save the minimum value of the curve
        \FPeval{\ymin}{0-\amplitude}

        % store the minimum height
        % for each period that we have to draw
        \foreach \loopNumber in {0,...,\nLoops}{
            % compute the starting location 
            \FPeval{\x}{\loopNumber * \period}
            % compute the midpoint
            \FPeval{\xMid}{\halfPeriod + \x}
            % compute the endpoint
            \FPeval{\xFinal}{\period + \x}
            % draw the period
            \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, rotate=\angle, xscale=\scale, yscale=\scale] 
                (\x,0) .. controls (\xMid, \ymin) and  (\xMid, \ymax) .. (\xFinal, 0);
        }
    }
}


% gluinos
\newcommand*{\gluino}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % enforce that endcaps is true
    \setkeys{style}{endcaps=true}
    % draw a fermion between the two points
    \fermion{#2}{#3}
    % draw a gluon between the two points
    \gluon{#2}{#3}
}


% sfermions
\newcommand*{\sfermion}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % enforce that endcaps is true
    \setkeys{style}{endcaps=true}
    % draw a fermion between the two points
    \fermion{#2}{#3}
    % draw a gluon between the two points
    \electroweak{#2}{#3}
}


% turn @ back into a special character
\makeatother


% draw an example diagram
\begin{document}
    \begin{feynman}[title=Example Feynman Diagram] 
        \sfermion{3,3}{3,0}
        \fermion{0,0}{0,2}
        \sfermion{0,2}{3,3}
        \gluino{0,0}{3,0}
    \end{feynman}
\end{document}


% end of file