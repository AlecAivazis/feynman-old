% -*- LaTeX -*-
% -*- coding: utf-8 -*-
%
% Alec Aivazis <alec@aivazis.com>
% 
% (c) 2009-2015 all rights reserved
%

% A package for drawing feynman diagrams in LaTex

\documentclass[border=1pt]{standalone}
\usepackage{xcolor}
\usepackage{tikz}
\usetikzlibrary{patterns}
\usepackage{xifthen}
\usepackage{kvoptions}
\usepackage{fp}

% turn off the fp messages
\FPmessagesfalse

% treat @ like a normal letter
\makeatletter


%------------------------------------------------------------------------------
% configuration parameters                                           
%------------------------------------------------------------------------------

% define the diagram configuration settings family
\SetupKeyvalOptions{family=diagram, prefix=diagram@}
\DeclareStringOption[in]{unit}
\DeclareStringOption[An Example Feynman Diagram]{title}

% define the propagator configuration settings family
\SetupKeyvalOptions{family=style, prefix=style@}
\DeclareStringOption[black]{color}[black]
\DeclareStringOption[1]{lineWidth}
\DeclareBoolOption[false]{endcaps}
\DeclareStringOption[1/3]{gluonWidth}
\DeclareStringOption[center]{location}
\DeclareStringOption{label}
\DeclareStringOption[0.5]{labelDistance}
\DeclareStringOption[0.5]{labelLocation}


%------------------------------------------------------------------------------
% the feynman diagram environment                                           
%------------------------------------------------------------------------------

% define an enviroment to encompass a single diagram
\newenvironment{feynman}[1][]
% before the content
{
    % load the diagram configuration settings
    \setkeys{diagram}{#1}
    % start the tikz environment
    \begin{tikzpicture}[x=1\diagram@unit, y=1\diagram@unit]
}
% after the content
{
    % close the tikz environment
    \end{tikzpicture}
}


%------------------------------------------------------------------------------
% utility macros
%------------------------------------------------------------------------------

% convert a particular length to the designated unit
% i.e. \convertto{mm}{1pt}
\newcommand*{\convertto}[2]{\strip@pt\dimexpr #2*65536/\number\dimexpr 1#1}

% compute the length between two points 
\def\calcLength(#1,#2)#3{
    % compute the delta between two points 
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas in the appropriate unit system
    \FPeval\@temp@a{\pgfmath@tonumber{\pgf@xa}/72.27}
    \FPeval\@temp@b{\pgfmath@tonumber{\pgf@ya}/72.27}

    % store the sum of the squares
    \FPeval\@temp@sum{(\@temp@a*\@temp@a+\@temp@b*\@temp@b)}
    % take the square root of the result
    \FProot{\FPMathLen}{\@temp@sum}{2}
    % cut off at 5 decimal places
    \FPround\FPMathLen\FPMathLen9\relax
    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\FPMathLen}
}

% compute the angle between two points 
\def\calcAngle(#1,#2)#3{
    % compute the difference between the two points
    \pgfpointdiff{\pgfpointanchor{#1}{center}}
                 {\pgfpointanchor{#2}{center}}
    % extract the delta between the two points
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    % cast the deltas as numbers
    \FPeval{\deltaX}{\pgfmath@tonumber{\pgf@xa}}
    \FPeval{\deltaY}{\pgfmath@tonumber{\pgf@ya}}
    % use pgf to compute atan2 
    \pgfmathparse{atan2(\deltaY, \deltaX)}
    %  set the angle to the result
    \FPeval{\angle}{round(\pgfmathresult , 5)}

    % set the value of the macro we were given
    \expandafter\edef\csname #3\endcsname{\angle}
}

% shortcut macro to print an expression to the console
\newcommand*{\print}[1]{\typeout{#1}}


%------------------------------------------------------------------------------
% patterns and colors
%------------------------------------------------------------------------------

% declare the parameters for the pattern
\tikzset{
    hatch distance/.store in=\hatchdistance,
    hatch distance=10pt,
    hatch thickness/.store in=\hatchthickness,
    hatch thickness=1pt
}
% define the pattern
\pgfdeclarepatternformonly[\hatchdistance,\hatchthickness]{parton}
% declare the origin
{\pgfqpoint{0pt}{0pt}}
% define the variables in this coordinate system
{\pgfqpoint{\hatchdistance}{\hatchdistance}}
{\pgfpoint{\hatchdistance-1pt}{\hatchdistance-1pt}}%
% set up the pattern
{
    \pgfsetcolor{\tikz@pattern@color}
    \pgfsetlinewidth{\hatchthickness}
    \pgfpathmoveto{\pgfqpoint{0pt}{0pt}}
    \pgfpathlineto{\pgfqpoint{\hatchdistance}{\hatchdistance}}
    \pgfusepath{stroke}
}


% define a light gray to be used as a fill color for partons
\definecolor{light-gray}{gray}{.7}



%------------------------------------------------------------------------------
% propagator styles
%------------------------------------------------------------------------------

% fermions
\newcommand*{\fermion}[3][]{
    % scope the configuration options 
    \begingroup
        % load the configuration parameters
        \setkeys{style}{#1}
        % draw the line
        \draw[color=\style@color, line width = \style@lineWidth] (#2) -- (#3);
        % draw the label
        \drawLabel{#2}{#3}
    \endgroup
}


% dashed propagators
\newcommand*{\dashed}[3][]{
    % scope the configuration options 
    \begingroup
        % load the configuration parameters
        \setkeys{style}{#1}
        % draw the dasked line
        \draw[\style@color, line width = \style@lineWidth, dashed] ({#2}) -- ({#3});
        % draw the label
        \drawLabel{#2}{#3}
    \endgroup
}


% gluons
\newcommand*{\gluon}[3][]{
    % scope the configuration options 
    \begingroup
        % load the configuration parameters
        \setkeys{style}{#1}

        % create TikZ coordinates at the end points
        \coordinate  (start) at (#2);
        \coordinate  (finish) at (#3);
        % store the distance between the two points
        \calcLength(start,finish){length} % stores it in a macro called \length
        % store the angle between the two points
        \calcAngle(start,finish){angle} % stores it in a macro called \angle

        % turn the start coordinate into a pgf point
        \pgfpointanchor{start}{center}
        \FPeval{\startX}{\pgfmath@tonumber{\pgf@x}}
        \FPeval{\startY}{\pgfmath@tonumber{\pgf@y}}

        \FPeval{\gluonWidth}{\style@gluonWidth}
        % store a value for half of the gluonWidth
        \FPeval{\halfWidth}{\gluonWidth/2}
        % store the closest whole number of full periods
        \FPeval{\nLoops}{round((\length / \gluonWidth ) - 1, 0)}
        \FPeval{\totalLength}{(\nLoops+1) * \gluonWidth}
        \FPeval{\scale}{\length / \totalLength}

        % if we dont fit a whole loop between the two points
        \ifthenelse{\equal{\nLoops}{0}}{
            % use a fermion line instead
            \fermion{#2}{#3}

        % we fit at least one loop between the two points
        }{

            % if they want the end caps (to draw the right kind of line)
            \ifstyle@endcaps
             
                \FPeval{\ymax}{\halfWidth}
                \FPeval{\ymin}{0-\halfWidth}

                % style the opening end cap
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, 
                    rotate=\angle, xscale=\scale, yscale=\scale] 
                    % draw the opening end cap
                    (0,0) .. controls (\halfWidth, 0) and (0, \ymin) .. (\halfWidth, \ymin);
                % for each loop that we have to draw
                \foreach \loopNumber in {1,...,\nLoops}{
                    % compute the starting location of the loop
                    \FPeval{\x}{\loopNumber * \gluonWidth - \halfWidth}
                    % compute the half way point of the loop
                    \FPeval{\xMid}{\halfWidth + \x}
                    % compute the endpoint of the loop
                    \FPeval{\xFinal}{\gluonWidth + \x}
                    
                    % style the first half of the loop
                    \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, 
                        rotate=\angle, xscale=\scale, yscale=\scale] 
                        % draw the first half of the loop
                        (\x, \ymin) .. controls (\xFinal, \ymin) and (\xFinal, \ymax) .. (\xMid, \ymax);
                    % style the second half of the loop
                    \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, 
                        rotate=\angle, xscale=\scale, yscale=\scale] 
                        % draw the second half of the loop
                        (\xMid, \ymax) .. controls (\x, \ymax) and (\x, \ymin) .. (\xFinal, \ymin);
                }

                % compute the locations for the closing end cap
                \FPeval{\finalStart}{(\nLoops+1) * \gluonWidth - \halfWidth}
                \FPeval{\finalHalf}{\finalStart + \halfWidth}
                \FPeval{\finalStop}{\finalStart + \halfWidth}
                % style the closing end cap
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, 
                    rotate=\angle, xscale=\scale, yscale=\scale] 
                    % draw the closing end cap
                    (\finalStart, \ymin) .. controls (\finalStop, \ymin) and (\finalStart, 0) .. (\finalStop, 0);

            % they did not want end caps
            \else
                % store a value for the height of the gluon loop
                \FPeval{\height}{\gluonWidth}
                % for each loop that we have to draw
                \foreach \loopNumber in {0,...,\nLoops}{
                    % compute the starting location of the loop
                    \FPeval{\x}{\loopNumber * \gluonWidth}
                    % compute the midpoint of the loop
                    \FPeval{\xMid}{\halfWidth + \x}
                    % compute the endpoint of the loop
                    \FPeval{\xFinal}{\gluonWidth + \x}
                    % style the first half of the loop
                    \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, 
                        rotate=\angle, xscale=\scale, yscale=\scale] 
                        % draw the first half of the loop
                        (\x,0) .. controls (\xFinal, 0) and  (\xFinal, \height) .. (\xMid, \height);
                    % style the second half of the loop
                    \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX, 
                        rotate=\angle, xscale=\scale, yscale=\scale] 
                        % draw the second half of the loop
                        (\xMid,\height) .. controls (\x, \height) and  (\x, 0) .. (\xFinal, 0);
                }
            \fi
        }
        % draw the label
        \drawLabel{#2}{#3}
    \endgroup
}


% electroweak lines
\newcommand*{\electroweak}[3][]{
    % scope the configuration options 
    \begingroup
        % load the configuration parameters
        \setkeys{style}{#1}

        % create TikZ coordinates at the end points
        \coordinate  (start) at (#2);
        \coordinate  (finish) at (#3);
        % store the distance between the two points
        \calcLength(start,finish){length} % stores it in a macro called \length
        % store the angle between the two points
        \calcAngle(start,finish){angle} % stores it in a macro called \angle

        % turn the start coordinate into a pgf point
        \pgfpointanchor{start}{center}
        \FPeval{\startX}{\pgfmath@tonumber{\pgf@x}}
        \FPeval{\startY}{\pgfmath@tonumber{\pgf@y}}

        \FPeval{\period}{\style@gluonWidth}
        % store a value for half of the gluonWidth
        \FPeval{\halfPeriod}{\period/2}
        % store the closest whole number of full periods
        \FPeval{\nLoops}{round((\length / \period ) - 1, 0)}
        \FPeval{\totalLength}{(\nLoops+1) * \period}
        \FPeval{\scale}{\length / \totalLength}

        % if we dont fit a whole loop between the two points
        \ifthenelse{\equal{\nLoops}{0}}{
            % use a fermion line instead
            \fermion{#2}{#3}

        % we fit at least one loop between the two points
        }{
            % store the amplitude of the curve
            \FPeval{\amplitude}{\period * 3 / 2}
            % save the maximum height of the curve
            \FPeval{\ymax}{\amplitude}
            % save the minimum value of the curve
            \FPeval{\ymin}{0-\amplitude}

            % store the minimum height
            % for each period that we have to draw
            \foreach \loopNumber in {0,...,\nLoops}{
                % compute the starting location 
                \FPeval{\x}{\loopNumber * \period}
                % compute the midpoint
                \FPeval{\xMid}{\halfPeriod + \x}
                % compute the endpoint
                \FPeval{\xFinal}{\period + \x}
                % style the period
                \draw[\style@color, line width = \style@lineWidth, yshift=\startY, xshift=\startX,
                    rotate=\angle, xscale=\scale, yscale=\scale] 
                    % place the period
                    (\x,0) .. controls (\xMid, \ymin) and  (\xMid, \ymax) .. (\xFinal, 0);
            }
        }
        % draw the label
        \drawLabel{#2}{#3}
    \endgroup
}


% gluinos
\newcommand*{\gluino}[3][]{
    % scope the configuration options 
    \begingroup
        % load the configuration parameters
        \setkeys{style}{#1}
        % enforce that endcaps is true
        \setkeys{style}{endcaps=true}
        % draw a fermion between the two points
        \fermion{#2}{#3}
        % draw a gluon between the two points
        \gluon{#2}{#3}
        % draw the label
        \drawLabel{#2}{#3}
    \endgroup
}


% sfermions
\newcommand*{\sfermion}[3][]{
    % scope the configuration options 
    \begingroup
        % load the configuration parameters
        \setkeys{style}{#1}
        % enforce that endcaps is true
        \setkeys{style}{endcaps=true}
        % draw a fermion between the two points
        \fermion{#2}{#3}
        % draw a gluon between the two points
        \electroweak{#2}{#3}
        % draw the label
        \drawLabel{#2}{#3}
    \endgroup
}


%------------------------------------------------------------------------------
% other objects
%------------------------------------------------------------------------------

% circle centered at #2 with radius #3
\newcommand*{\parton}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % style the circle 
    \draw[\style@color, line width = \style@lineWidth, pattern=parton,
        pattern color=light-gray] 
        % draw the circle
        (#2) circle (#3 \diagram@unit);
}


% text a located at #2 with content #3
\newcommand*{\text}[3][]{
    % load the configuration parameters
    \setkeys{style}{#1}
    % create a node at the location with the given contents
    \draw[text=\style@color, anchor=\style@location] (#2) node {#3};
}


% draw a label using the coordinate system along the line joining #1 and #2
\newcommand*{\drawLabel}[2]{

    % if they provided a value for the label
    \ifthenelse{\equal{\style@label}{}}{}{

        % create TikZ coordinates at the end points
        \coordinate  (start) at (#1);
        \coordinate  (finish) at (#2);

        % compute the difference between the two points
        \pgfpointdiff{\pgfpointanchor{start}{center}}
                     {\pgfpointanchor{finish}{center}}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        % cast the deltas in the appropriate unit system
        \FPeval\dX{\pgfmath@tonumber{\pgf@xa}/72.27}
        \FPeval\dY{\pgfmath@tonumber{\pgf@ya}/72.27}

        % compute the location of the starting coordinate
        \pgfpointanchor{start}{center}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        \FPeval{\@temp@x1}{round(\pgfmath@tonumber{\pgf@xa}/72.27, 5)}
        \FPeval{\@temp@y1}{round(\pgfmath@tonumber{\pgf@ya}/72.27, 5)}

        % store local copies of the target position
        \FPeval{\labelLocation}{\style@labelLocation}
        \FPeval{\labelDistance}{0+\style@labelDistance}

        % compute the location along the line where we belong
        \FPeval{\@temp@locX}{round(\@temp@x1 + \labelLocation * \dX, 5)}
        \FPeval{\@temp@locY}{round(\@temp@y1 + \labelLocation * \dY, 5)}


        % if the change in y is zero (infinite slope)
        \ifthenelse{\equal{\dY}{0}}{
            \FPeval{\labelX}{\@temp@locX}
            \FPeval{\labelY}{\@temp@locY+\labelDistance}
            \def\loc{right}
        % otherwise we are safe to compute the slope
        }{
            % compute the slope of the perpendicular line
            \FPeval{\perpSlope}{0 - \dX/\dY}
            \FPeval{\roundedSlope}{round(\perpSlope,0)}
            \FPeval{\roundedDistance}{round(\labelDistance, 0)}

            % the points that are perpedicular to the line a distance r away satisfy
            % y = mx
            % x^2 + y^2 = r

            % compute the x that satisfies this equation
            \FPeval{\x2}{(0+\labelDistance) * (0+\labelDistance) / (1 + (\perpSlope * \perpSlope))}
            \FProot{\x}{\x2}{2}
            % compute the y that satisfies this equation
            \FPeval{\y}{\x * \perpSlope}

            % if the perpendicular line has positive slope
            \ifthenelse{\roundedSlope > 0 \OR \roundedSlope = 0}{
                % if they are a positive distance away
                \ifthenelse{\roundedDistance > 0}{
                    \FPeval{\labelX}{\@temp@locX + \x}
                    \FPeval{\labelY}{\@temp@locY + \y}
                    \def\loc{right}
                % otherwise they are a negative distance away
                }{
                    \FPeval{\labelX}{\@temp@locX - \x}
                    \FPeval{\labelY}{\@temp@locY - \y}
                    \def\loc{right}
                }
            % otherwise the perpendicular line as negative slope
            }{
                % if the label is a positive distance away
                \ifthenelse{\roundedDistance > 0}{
                    \FPeval{\labelX}{\@temp@locX - \x}
                    \FPeval{\labelY}{\@temp@locY - \y}
                    \def\loc{right}
                % otherwise the label is a negative distance from the line
                }{
                    \FPeval{\labelX}{\@temp@locX + \x}
                    \FPeval{\labelY}{\@temp@locY + \y}
                    \def\loc{right}
                }

            }
        }
        % draw the label
        \draw[\loc] (\labelX,\labelY) node {\style@label};
    }

}

%------------------------------------------------------------------------------
% cleanup
%------------------------------------------------------------------------------

% turn @ back into a special character
\makeatother


%------------------------------------------------------------------------------
% example
%------------------------------------------------------------------------------

% draw an example diagram
\begin{document}
    
    \begin{feynman}[title=Example Feynman Diagram] 
        \fermion[label=hello, labelDistance = -0.5]{0,2}{1,1}
        \fermion[label=goodbye, labelDistance = -0.5]{0,0}{1,1}

        \fermion[label=$x^2$, labelDistance = 0.5]{0,2}{4,2}

        \electroweak[color=blue]{1,1}{3,1}

        \fermion[label=hello, labelDistance = -0.5]{3,1}{4,2}
        \fermion[label=goodbye, labelDistance = 0.5]{3,1}{4,0}
    \end{feynman}

\end{document}


% end of file